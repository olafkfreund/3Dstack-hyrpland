name: Package & Release

on:
  release:
    types: [ published ]
  workflow_dispatch:

env:
  PLUGIN_NAME: hyprland-stack3d

jobs:
  # Build and attach binary to release
  build-release:
    name: Build Release Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Nix
        uses: cachix/install-nix-action@v23
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build plugin
        run: |
          nix develop --command make clean
          nix develop --command make
          
      - name: Create release package
        run: |
          mkdir -p release-package
          cp stack3d.so release-package/
          cp hyprland_stack3d_plugin.md release-package/README.md
          cp examples/hyprland.conf release-package/example-hyprland.conf
          tar czf hyprland-stack3d-${{ github.ref_name }}.tar.gz release-package/
          
      - name: Upload to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./hyprland-stack3d-${{ github.ref_name }}.tar.gz
          asset_name: hyprland-stack3d-${{ github.ref_name }}.tar.gz
          asset_content_type: application/gzip