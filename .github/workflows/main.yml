name: Build Distribution Packages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PLUGIN_NAME: stack3d

jobs:
  # Build packages for Debian, Fedora, and Arch
  build-packages:
    name: Build Distribution Packages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install package build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-deb rpm build-essential
        
      - name: Build Debian package
        run: |
          echo "Building Debian .deb package..."
          mkdir -p packages/debian/hyprland-stack3d-1.0.0/DEBIAN
          mkdir -p packages/debian/hyprland-stack3d-1.0.0/usr/lib/hyprland
          mkdir -p packages/debian/hyprland-stack3d-1.0.0/usr/share/doc/hyprland-stack3d
          
          # Create placeholder for plugin binary (to be replaced by user after nix build)
          echo "# Placeholder - replace with actual stack3d.so from 'nix build'" > packages/debian/hyprland-stack3d-1.0.0/usr/lib/hyprland/stack3d.so.placeholder
          
          # Control file
          cat > packages/debian/hyprland-stack3d-1.0.0/DEBIAN/control << 'EOF'
          Package: hyprland-stack3d
          Version: 1.0.0
          Section: x11
          Priority: optional
          Architecture: amd64
          Depends: hyprland
          Maintainer: Stack3D Team <team@example.com>
          Description: 3D stack layout plugin for Hyprland
           Adds 3D perspective stack window management to Hyprland compositor
           with physics-based animations and smooth transitions.
           .
           This package provides advanced window stacking capabilities including:
           * Physics-based animations with spring dynamics
           * Multiple layout modes (grid, cascade, spiral)  
           * Customizable transition effects
           * Bezier curve easing functions
           * Motion blur effects
           * Configurable keybindings
           .
           The plugin integrates seamlessly with Hyprland's existing window
           management system and can be controlled via hyprctl commands.
           .
           Note: Install nix and run 'nix build' to generate the plugin binary.
          EOF
          
          # Post-install script to guide user
          cat > packages/debian/hyprland-stack3d-1.0.0/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          
          echo ""
          echo "=========================================="
          echo "  Hyprland Stack3D Plugin Installation"
          echo "=========================================="
          echo ""
          echo "Package installed successfully!"
          echo ""
          echo "To complete the installation:"
          echo "1. Install Nix: curl -L https://nixos.org/nix/install | sh"
          echo "2. Clone repository: git clone https://github.com/olafkfreund/3Dstack-hyrpland.git"
          echo "3. Build plugin: cd 3Dstack-hyrpland && nix build"
          echo "4. Copy plugin: sudo cp result/lib/stack3d.so /usr/lib/hyprland/"
          echo "5. Add to Hyprland config: plugin = /usr/lib/hyprland/stack3d.so"
          echo ""
          echo "Documentation: /usr/share/doc/hyprland-stack3d/"
          echo ""
          EOF
          chmod 755 packages/debian/hyprland-stack3d-1.0.0/DEBIAN/postinst
          
          # Copy documentation
          cp hyprland_stack3d_plugin.md packages/debian/hyprland-stack3d-1.0.0/usr/share/doc/hyprland-stack3d/README.md
          cp examples/hyprland.conf packages/debian/hyprland-stack3d-1.0.0/usr/share/doc/hyprland-stack3d/example-hyprland.conf
          
          # Create install instructions
          cat > packages/debian/hyprland-stack3d-1.0.0/usr/share/doc/hyprland-stack3d/INSTALL.md << 'EOF'
          # Installation Instructions
          
          ## Building the Plugin
          
          This package provides the framework. You need to build the actual plugin:
          
          1. Install Nix (if not already installed):
             ```bash
             curl -L https://nixos.org/nix/install | sh
             source ~/.nix-profile/etc/profile.d/nix.sh
             ```
          
          2. Clone and build the plugin:
             ```bash
             git clone https://github.com/olafkfreund/3Dstack-hyrpland.git
             cd 3Dstack-hyrpland
             nix build
             ```
          
          3. Install the built plugin:
             ```bash
             sudo cp result/lib/stack3d.so /usr/lib/hyprland/
             ```
          
          4. Add to your Hyprland configuration:
             ```
             plugin = /usr/lib/hyprland/stack3d.so
             ```
          
          5. Test with: `hyprctl dispatch stack3d toggle`
          
          ## Configuration
          
          Add plugin settings to your Hyprland config:
          
          ```
          plugin {
              stack3d {
                  enable = true
                  transition_duration = 0.8
                  default_layout = grid
              }
          }
          
          # Keybindings
          bind = SUPER, grave, stack3d, toggle
          bind = SUPER SHIFT, grave, stack3d, cycle_layout
          ```
          EOF
          
          # Build the .deb package
          dpkg-deb --build packages/debian/hyprland-stack3d-1.0.0
          mv packages/debian/hyprland-stack3d-1.0.0.deb packages/hyprland-stack3d_1.0.0_amd64.deb
          echo "Debian package created: hyprland-stack3d_1.0.0_amd64.deb"
          
      - name: Build RPM package
        run: |
          echo "Building RPM package..."
          
          # Create RPM build directories
          mkdir -p ~/rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p packages/fedora/hyprland-stack3d-1.0.0/usr/lib64/hyprland
          mkdir -p packages/fedora/hyprland-stack3d-1.0.0/usr/share/doc/hyprland-stack3d
          
          # Create placeholder for plugin binary
          echo "# Placeholder - replace with actual stack3d.so from 'nix build'" > packages/fedora/hyprland-stack3d-1.0.0/usr/lib64/hyprland/stack3d.so.placeholder
          
          # Copy documentation
          cp hyprland_stack3d_plugin.md packages/fedora/hyprland-stack3d-1.0.0/usr/share/doc/hyprland-stack3d/README.md
          cp examples/hyprland.conf packages/fedora/hyprland-stack3d-1.0.0/usr/share/doc/hyprland-stack3d/example-hyprland.conf
          
          # Create install instructions
          cat > packages/fedora/hyprland-stack3d-1.0.0/usr/share/doc/hyprland-stack3d/INSTALL.md << 'EOF'
          # Installation Instructions
          
          This RPM provides the framework. Build the plugin with:
          
          1. Install Nix: curl -L https://nixos.org/nix/install | sh
          2. Clone: git clone https://github.com/olafkfreund/3Dstack-hyrpland.git
          3. Build: cd 3Dstack-hyrpland && nix build
          4. Install: sudo cp result/lib/stack3d.so /usr/lib64/hyprland/
          5. Configure Hyprland: plugin = /usr/lib64/hyprland/stack3d.so
          EOF
          
          # Create RPM spec file
          cat > ~/rpmbuild/SPECS/hyprland-stack3d.spec << 'EOF'
          Name:           hyprland-stack3d
          Version:        1.0.0
          Release:        1%{?dist}
          Summary:        3D stack layout plugin for Hyprland
          
          License:        MIT
          URL:            https://github.com/olafkfreund/3Dstack-hyrpland
          Source0:        %{name}-%{version}.tar.gz
          
          Requires:       hyprland, pixman, libdrm
          BuildArch:      x86_64
          
          %description
          3D stack layout plugin for Hyprland with physics-based animations 
          and smooth transitions.
          
          Features:
          * Physics-based animations with spring dynamics
          * Multiple layout modes (grid, cascade, spiral)
          * Customizable transition effects  
          * Bezier curve easing functions
          * Motion blur effects
          * Configurable keybindings
          
          Note: Requires building with Nix. See documentation for details.
          
          %prep
          %setup -q
          
          %build
          # Build step handled by user with Nix
          
          %install
          mkdir -p %{buildroot}/usr/lib64/hyprland
          mkdir -p %{buildroot}/usr/share/doc/%{name}
          cp usr/lib64/hyprland/stack3d.so.placeholder %{buildroot}/usr/lib64/hyprland/
          cp usr/share/doc/%{name}/* %{buildroot}/usr/share/doc/%{name}/
          
          %post
          echo ""
          echo "=========================================="
          echo "  Hyprland Stack3D Plugin Installation"
          echo "=========================================="
          echo ""
          echo "RPM installed successfully!"
          echo ""
          echo "To complete the installation:"
          echo "1. Install Nix: curl -L https://nixos.org/nix/install | sh"
          echo "2. Clone repository: git clone https://github.com/olafkfreund/3Dstack-hyrpland.git"
          echo "3. Build plugin: cd 3Dstack-hyrpland && nix build"
          echo "4. Copy plugin: sudo cp result/lib/stack3d.so /usr/lib64/hyprland/"
          echo "5. Add to Hyprland config: plugin = /usr/lib64/hyprland/stack3d.so"
          echo ""
          echo "Documentation: /usr/share/doc/hyprland-stack3d/"
          echo ""
          
          %files
          /usr/lib64/hyprland/stack3d.so.placeholder
          /usr/share/doc/%{name}/
          
          %changelog
          * $(date '+%a %b %d %Y') Stack3D Team <team@example.com> - 1.0.0-1
          - Initial release
          - 3D window stacking with physics animations
          - Multiple layout modes and customization options
          EOF
          
          # Create source tarball
          cd packages/fedora
          tar czf ~/rpmbuild/SOURCES/hyprland-stack3d-1.0.0.tar.gz hyprland-stack3d-1.0.0/
          
          # Build the RPM
          rpmbuild -ba ~/rpmbuild/SPECS/hyprland-stack3d.spec
          
          # Copy the built RPM to packages directory
          cp ~/rpmbuild/RPMS/x86_64/hyprland-stack3d-1.0.0-1.*.rpm packages/hyprland-stack3d-1.0.0-1.x86_64.rpm
          echo "RPM package created: hyprland-stack3d-1.0.0-1.x86_64.rpm"
          
      - name: Create Arch PKGBUILD
        run: |
          echo "Creating Arch PKGBUILD..."
          mkdir -p packages/arch/hyprland-stack3d-1.0.0
          
          # Copy documentation
          cp hyprland_stack3d_plugin.md packages/arch/hyprland-stack3d-1.0.0/README.md
          cp examples/hyprland.conf packages/arch/hyprland-stack3d-1.0.0/example-hyprland.conf
          
          # Create install instructions
          cat > packages/arch/hyprland-stack3d-1.0.0/INSTALL.md << 'EOF'
          # Arch Linux Installation
          
          ## Option 1: Using makepkg (recommended)
          
          1. Extract this package
          2. Run: `makepkg -si`
          3. The package will automatically build with Nix and install
          
          ## Option 2: Manual installation
          
          1. Install Nix: `curl -L https://nixos.org/nix/install | sh`
          2. Clone: `git clone https://github.com/olafkfreund/3Dstack-hyrpland.git`
          3. Build: `cd 3Dstack-hyrpland && nix build`
          4. Install: `sudo cp result/lib/stack3d.so /usr/lib/hyprland/`
          
          ## Configuration
          
          Add to ~/.config/hypr/hyprland.conf:
          
          ```
          plugin = /usr/lib/hyprland/stack3d.so
          
          plugin {
              stack3d {
                  enable = true
                  transition_duration = 0.8
                  default_layout = grid
              }
          }
          
          bind = SUPER, grave, stack3d, toggle
          bind = SUPER SHIFT, grave, stack3d, cycle_layout
          ```
          EOF
          
          # Create PKGBUILD
          cat > packages/arch/hyprland-stack3d-1.0.0/PKGBUILD << 'EOF'
          # Maintainer: Stack3D Team <team@example.com>
          
          pkgname=hyprland-stack3d
          pkgver=1.0.0
          pkgrel=1
          pkgdesc="3D stack layout plugin for Hyprland"
          arch=('x86_64')
          url="https://github.com/olafkfreund/3Dstack-hyrpland"
          license=('MIT')
          depends=('hyprland' 'pixman' 'libdrm')
          makedepends=('nix' 'git')
          source=("${pkgname}-${pkgver}.tar.gz::https://github.com/olafkfreund/3Dstack-hyrpland/archive/v${pkgver}.tar.gz")
          sha256sums=('SKIP')
          
          prepare() {
              cd "$srcdir/3Dstack-hyrpland-${pkgver}"
              
              # Initialize Nix if needed
              if [[ ! -f ~/.nix-profile/etc/profile.d/nix.sh ]] && [[ -f /etc/profile.d/nix.sh ]]; then
                  source /etc/profile.d/nix.sh
              elif [[ -f ~/.nix-profile/etc/profile.d/nix.sh ]]; then
                  source ~/.nix-profile/etc/profile.d/nix.sh
              fi
          }
          
          build() {
              cd "$srcdir/3Dstack-hyrpland-${pkgver}"
              
              msg2 "Building plugin with Nix..."
              nix build
          }
          
          package() {
              cd "$srcdir/3Dstack-hyrpland-${pkgver}"
              
              # Install plugin binary
              install -Dm755 "result/lib/stack3d.so" "$pkgdir/usr/lib/hyprland/stack3d.so"
              
              # Install documentation
              install -Dm644 "hyprland_stack3d_plugin.md" "$pkgdir/usr/share/doc/$pkgname/README.md"
              install -Dm644 "examples/hyprland.conf" "$pkgdir/usr/share/doc/$pkgname/example-hyprland.conf"
              
              # Create post-install message
              mkdir -p "$pkgdir/usr/share/libalpm/hooks"
              cat > "$pkgdir/usr/share/libalpm/hooks/hyprland-stack3d.hook" << 'HOOKEOF'
          [Trigger]
          Operation = Install
          Operation = Upgrade
          Type = Package
          Target = hyprland-stack3d
          
          [Action]
          Description = Hyprland Stack3D Plugin Setup
          When = PostTransaction
          Exec = /usr/bin/echo -e "\n====== Hyprland Stack3D Plugin v1.0.0 ======\nPlugin installed to: /usr/lib/hyprland/stack3d.so\n\nAdd to your Hyprland config:\nplugin = /usr/lib/hyprland/stack3d.so\n\nDocumentation: /usr/share/doc/hyprland-stack3d/\n============================================\n"
          HOOKEOF
              
              # Install configuration example
              install -Dm644 "examples/hyprland.conf" "$pkgdir/usr/share/doc/$pkgname/hyprland-config-example.conf"
          }
          EOF
          
          # Create .SRCINFO
          cat > packages/arch/hyprland-stack3d-1.0.0/.SRCINFO << 'EOF'
          pkgbase = hyprland-stack3d
          	pkgdesc = 3D stack layout plugin for Hyprland
          	pkgver = 1.0.0
          	pkgrel = 1
          	url = https://github.com/olafkfreund/3Dstack-hyrpland
          	arch = x86_64
          	license = MIT
          	makedepends = nix
          	makedepends = git
          	depends = hyprland
          	depends = pixman
          	depends = libdrm
          	source = hyprland-stack3d-1.0.0.tar.gz::https://github.com/olafkfreund/3Dstack-hyrpland/archive/v1.0.0.tar.gz
          	sha256sums = SKIP
          
          pkgname = hyprland-stack3d
          EOF
          
          # Create Arch package tarball (for AUR submission)
          cd packages/arch
          tar czf hyprland-stack3d-1.0.0-PKGBUILD.tar.gz hyprland-stack3d-1.0.0/
          mv hyprland-stack3d-1.0.0-PKGBUILD.tar.gz ../hyprland-stack3d-1.0.0-PKGBUILD.tar.gz
          echo "Arch PKGBUILD package created: hyprland-stack3d-1.0.0-PKGBUILD.tar.gz"
          
      - name: Create final packages
        run: |
          echo "Organizing final packages..."
          cd packages
          
          # Create installation guide
          cat > INSTALLATION.md << 'EOF'
          # Hyprland Stack3D Plugin Installation Guide
          
          ## Available Packages
          
          - `hyprland-stack3d_1.0.0_amd64.deb` - Debian/Ubuntu package
          - `hyprland-stack3d-1.0.0-1.x86_64.rpm` - Fedora/RHEL package  
          - `hyprland-stack3d-1.0.0-PKGBUILD.tar.gz` - Arch Linux PKGBUILD
          
          ## Installation Instructions
          
          ### Debian/Ubuntu
          ```bash
          sudo dpkg -i hyprland-stack3d_1.0.0_amd64.deb
          # Follow the post-installation instructions
          ```
          
          ### Fedora/RHEL
          ```bash
          sudo rpm -ivh hyprland-stack3d-1.0.0-1.x86_64.rpm
          # Follow the post-installation instructions
          ```
          
          ### Arch Linux
          ```bash
          # Extract and use makepkg
          tar xzf hyprland-stack3d-1.0.0-PKGBUILD.tar.gz
          cd hyprland-stack3d-1.0.0
          makepkg -si
          ```
          
          ## Post-Installation
          
          All packages require building the plugin with Nix:
          
          1. Install Nix: `curl -L https://nixos.org/nix/install | sh`
          2. Clone repo: `git clone https://github.com/olafkfreund/3Dstack-hyrpland.git`
          3. Build: `cd 3Dstack-hyrpland && nix build`
          4. Copy plugin to system location (as shown in package post-install)
          5. Add to Hyprland config: `plugin = /usr/lib/hyprland/stack3d.so`
          
          ## Configuration
          
          Add to ~/.config/hypr/hyprland.conf:
          
          ```
          plugin = /usr/lib/hyprland/stack3d.so
          
          plugin {
              stack3d {
                  enable = true
                  transition_duration = 0.8
                  default_layout = grid
              }
          }
          
          bind = SUPER, grave, stack3d, toggle
          bind = SUPER SHIFT, grave, stack3d, cycle_layout
          ```
          EOF
          
          echo "Final packages ready:"
          ls -la *.deb *.rpm *.tar.gz 2>/dev/null || true
          
      - name: Create checksums
        run: |
          cd packages
          sha256sum *.deb *.rpm *.tar.gz > checksums.sha256
          echo "Checksums created:"
          cat checksums.sha256
          
      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: distribution-packages
          path: |
            packages/*.deb
            packages/*.rpm  
            packages/*.tar.gz
            packages/checksums.sha256
            packages/INSTALLATION.md
          retention-days: 30
          
      - name: Package Summary
        run: |
          echo "Distribution packages built successfully!"
          echo ""
          echo "Built packages:"
          ls -la packages/*.deb packages/*.rpm packages/*.tar.gz
          echo ""
          echo "Package checksums:"
          cat packages/checksums.sha256
          echo ""
          echo "Package Types Created:"
          echo "  - Debian: .deb package with post-install instructions"
          echo "  - Fedora: .rpm package with post-install scripts"  
          echo "  - Arch: PKGBUILD for makepkg installation"
          echo ""
          echo "Installation: Each package guides users through Nix build process"
          echo "Total packages created: $(ls packages/*.deb packages/*.rpm packages/*.tar.gz | wc -l)"

      - name: Release Information
        run: |
          echo "==============================================="
          echo "           HYPRLAND STACK3D PLUGIN v1.0.0"
          echo "==============================================="
          echo ""
          echo "Real distribution packages created and uploaded as workflow artifacts."
          echo ""
          echo "Package Types:"
          echo "  - hyprland-stack3d_1.0.0_amd64.deb (Debian/Ubuntu)"
          echo "  - hyprland-stack3d-1.0.0-1.x86_64.rpm (Fedora/RHEL)"
          echo "  - hyprland-stack3d-1.0.0-PKGBUILD.tar.gz (Arch Linux)"
          echo ""
          echo "Users can install these packages which will:"
          echo "  1. Install framework and documentation"
          echo "  2. Show post-install instructions for building with Nix"
          echo "  3. Guide through plugin installation process"
          echo ""
          echo "To create GitHub release:"
          echo "  1. Download artifacts from this workflow"
          echo "  2. Create release at: https://github.com/olafkfreund/3Dstack-hyrpland/releases/new"
          echo "  3. Tag: v1.0.0, attach all package files"